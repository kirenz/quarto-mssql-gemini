---
title: "Sales Analysis Report"
subtitle: "With AI generated explanations"
author: Mike Farmer
date: today
date-format: long
format:
  typst:
    mainfont: "Agbalumo"
    columns: 1
    papersize: a4
    toc: true
    toc-depth: 2
    number-sections: true
    toc-page-break: true
jupyter:
  kernelspec:
    name: gradio-mssql-gemini
    display_name: gradio-mssql-gemini
    language: python
---


```{=typst}
#let analysis-box(content) = {
  block(
    fill: rgb("#f1f5f9"),
    inset: 1em,
    radius: 4pt,
    width: 100%,
  )[
    #text(weight: "bold")[AI Analysis]
    #v(0.5em)
    #content
  ]
}
```

```{python}
#| echo: false
#| output: asis

import pandas as pd
from ai_analysis import get_plot_description
from db_setup import get_sales_data
import altair as alt
import os
import json
from datetime import datetime

# Create output directory for plots - using relative path
output_dir = 'plots'  # This will create a 'plots' directory in the same folder as the qmd file
os.makedirs(output_dir, exist_ok=True)

# Function to get relative path for images
def get_image_path(filename):
    return f"./plots/{filename}"

# Load filters from JSON file
filters_file = 'current_filters.json'
if os.path.exists(filters_file):
    with open(filters_file, 'r') as f:
        filters = json.load(f)
else:
    filters = {
        'sales_org': "All",
        'country': "All",
        'region': "All",
        'city': "All",
        'product_line': "All",
        'product_category': "All"
    }

# Get the data with filters
df_sales = get_sales_data(**filters)

# Sort by date
df_sales = df_sales.sort_values('Calendar DueDate')

# Add filter information for context
filters_used = {
    'Sales Organization': filters['sales_org'],
    'Country': filters['country'],
    'Region': filters['region'],
    'City': filters['city'],
    'Product Line': filters['product_line'],
    'Product Category': filters['product_category']
}

# Create filter text for display
def format_filter_value(value):
    if value == "All":
        return value
    if isinstance(value, list):
        return ", ".join(value)
    return str(value)

active_filters = [
    f"{k.replace('_', ' ').title()}: {format_filter_value(v)}" 
    for k, v in filters.items() 
    if v != "All"
]
filter_text = "No filters applied" if not active_filters else "\n".join(active_filters)

# print(f"""Applied Filters

# {filter_text}
# """)

print(f'''```{{=typst}}
#analysis-box[
  {filter_text}
]
```''')
```





```{=typst}
#pagebreak()
```

# Sales Performance Overview 

```{python}
#| echo: false
#| output: asis

# Helper function to get the primary group by field
def get_primary_dimension():
    non_all_filters = {k: v for k, v in filters.items() if v != "All"}
    dimension_mapping = {
        'city': 'Sales City',
        'region': 'Sales Region',
        'country': 'Sales Country',
        'sales_org': 'Sales Organisation',
        'product_category': 'Product Category',
        'product_line': 'Product Line'
    }
    
    # Return first non-"All" filter's corresponding dimension
    for key in ['city', 'region', 'country', 'sales_org', 'product_category', 'product_line']:
        if key in non_all_filters:
            return dimension_mapping[key]
    return 'Calendar Month'  # default if no specific filters

# Create chart based on filters
primary_dim = get_primary_dimension()

if primary_dim == 'Calendar Month':
    # Single line chart for total revenue
    summary = df_sales.groupby('Calendar Month')[['Revenue EUR']].sum().reset_index()
    chart = alt.Chart(summary).mark_line(point=True).encode(
        x=alt.X('Calendar Month:O', title='Month'),
        y=alt.Y('Revenue EUR:Q', title='Revenue (EUR)'),
        tooltip=['Calendar Month', 'Revenue EUR']
    )
else:
    # Multi-line chart grouped by the primary dimension
    summary = df_sales.groupby(['Calendar Month', primary_dim])[['Revenue EUR']].sum().reset_index()
    chart = alt.Chart(summary).mark_line(point=True).encode(
        x=alt.X('Calendar Month:O', title='Month'),
        y=alt.Y('Revenue EUR:Q', title='Revenue (EUR)'),
        color=alt.Color(f'{primary_dim}:N', title=primary_dim.replace('Sales ', '')),
        tooltip=['Calendar Month', primary_dim, 'Revenue EUR']
    )

chart = chart.properties(
    width=800,
    height=400,
    title='Monthly Revenue by ' + primary_dim.replace('Sales ', '')
)

# Save and display chart
chart.save(os.path.join(output_dir, 'monthly_revenue.png'))
print(f"![Monthly Revenue Chart]({get_image_path('monthly_revenue.png')})")

# Prepare metrics for AI analysis
monthly_metrics = {
    'Total Revenue': f"€{summary['Revenue EUR'].sum():,.0f}",
    'Average Monthly Revenue': f"€{summary['Revenue EUR'].mean():,.0f}",
    'Peak Month': f"{summary['Revenue EUR'].idxmax()} (€{summary['Revenue EUR'].max():,.0f})",
    'Lowest Month': f"{summary['Revenue EUR'].idxmin()} (€{summary['Revenue EUR'].min():,.0f})"
}

# Format metrics for the prompt
monthly_metrics_text = "\n".join(f"{k}: {v}" for k, v in monthly_metrics.items())

# Generate AI description
monthly_analysis = get_plot_description(
    "Monthly revenue trends",
    monthly_metrics_text
)

print(f'''```{{=typst}}
#analysis-box[
  {monthly_analysis}
]
```''')
```



```{=typst}
#pagebreak()
```

# Regional Performance Deep Dive

```{python}
#| echo: false
#| output: asis

# Group by region and calculate key metrics
regional_summary = df_sales.groupby('Sales Region')[['Sales Amount', 'Revenue EUR', 'Gross Profit EUR']].sum().reset_index()

# Reshape data for better display
display_df = regional_summary.copy()
display_df.columns = ['Region', 'Total Units Sold', 'Revenue (EUR)', 'Gross Profit (EUR)']

# Save the table as an HTML snippet for Typst display
display_df['Revenue (EUR)'] = display_df['Revenue (EUR)'].map('{:,.0f}'.format)
display_df['Gross Profit (EUR)'] = display_df['Gross Profit (EUR)'].map('{:,.0f}'.format)

table_md = "\n".join(
    ["Region | Total Units Sold | Revenue (EUR) | Gross Profit (EUR)",
     "------ | ---------------- | ------------- | ------------------"] +
    [f"{row['Region']} | {row['Total Units Sold']:,} | €{row['Revenue (EUR)']} | €{row['Gross Profit (EUR)']}"
     for _, row in display_df.iterrows()]
)

print("```{=markdown}\n" + table_md + "\n```")

# Create a bar chart for regional revenue
regional_chart = alt.Chart(regional_summary).mark_bar().encode(
    x=alt.X('Sales Region:N', title='Region'),
    y=alt.Y('Revenue EUR:Q', title='Revenue (EUR)'),
    tooltip=['Sales Region', 'Revenue EUR', 'Gross Profit EUR']
).properties(
    width=800,
    height=400,
    title='Revenue by Region'
)

regional_chart.save(os.path.join(output_dir, 'regional_revenue.png'))
print(f"![Regional Revenue Chart]({get_image_path('regional_revenue.png')})")

# Prepare metrics for AI analysis
regional_metrics = {
    'Top Region': regional_summary.loc[regional_summary['Revenue EUR'].idxmax(), 'Sales Region'],
    'Top Region Revenue': f"€{regional_summary['Revenue EUR'].max():,.0f}",
    'Most Profitable Region': regional_summary.loc[regional_summary['Gross Profit EUR'].idxmax(), 'Sales Region'],
    'Most Profitable Region Profit': f"€{regional_summary['Gross Profit EUR'].max():,.0f}",
}

regional_metrics_text = "\n".join(f"{k}: {v}" for k, v in regional_metrics.items())

regional_analysis = get_plot_description(
    "Regional performance across all filters",
    regional_metrics_text
)

print(f'''```{{=typst}}
#analysis-box[
  {regional_analysis}
]
```''')
```



```{=typst}
#pagebreak()
```

# Product Category Insights

```{python}
#| echo: false
#| output: asis

product_summary = df_sales.groupby('Product Category')[['Revenue EUR', 'Gross Profit EUR', 'Sales Amount']].sum().reset_index()

product_chart = alt.Chart(product_summary).mark_bar().encode(
    x=alt.X('Product Category:N', title='Product Category'),
    y=alt.Y('Revenue EUR:Q', title='Revenue (EUR)'),
    tooltip=['Product Category', 'Revenue EUR', 'Gross Profit EUR', 'Sales Amount']
).properties(
    width=800,
    height=400,
    title='Revenue by Product Category'
)

product_chart.save(os.path.join(output_dir, 'product_revenue.png'))
print(f"![Product Revenue Chart]({get_image_path('product_revenue.png')})")

product_metrics = {
    'Top Category': product_summary.loc[product_summary['Revenue EUR'].idxmax(), 'Product Category'],
    'Top Category Revenue': f"€{product_summary['Revenue EUR'].max():,.0f}",
    'Top Category Profit': f"€{product_summary['Gross Profit EUR'].max():,.0f}",
}

product_metrics_text = "\n".join(f"{k}: {v}" for k, v in product_metrics.items())
product_analysis = get_plot_description(
    "Product category performance insights",
    product_metrics_text
)

print(f'''```{{=typst}}
#analysis-box[
  {product_analysis}
]
```''')
```
