---
title: "German Sales Analysis"
subtitle: "With AI generated explanations"
author: Mike Farmer
date: today
date-format: long
format:
  typst:
    columns: 1
    papersize: a4
    toc: true
    toc-depth: 2
    toc-page-break: true
jupyter:
  kernelspec:
    name: gradio-mssql-gemini
    display_name: gradio-mssql-gemini
    language: python
---

```{python}
#| echo: false
import pandas as pd
from quarto_mssql_gemini.ai.narrative import generate_sales_narrative
from quarto_mssql_gemini.data_access import get_germany_sales_data
#import matplotlib.pyplot as plt
```

```{python}
#| echo: false
# Get the data from database
germany_sales = get_germany_sales_data().sort_values('Calendar DueDate').copy()
```


```{=typst}
#let analysis-box(content) = {
  block(
    fill: rgb("#f1f5f9"),
    inset: 1em,
    radius: 4pt,
    width: 100%,
  )[
    #text(weight: "bold")[AI Analysis]
    #v(0.5em)
    #content
  ]
}
```


```{=typst}
#pagebreak()
```


# Regional Analysis

```{python}
#| echo: false
#| fig-width: 8
#| fig-height: 4
#| output: asis


# Calculate regional performance
region_summary = germany_sales.groupby('Sales Region').agg({
    'Revenue EUR': 'sum',
    'Gross Profit EUR': 'sum'
}).round(2)

# Convert to more presentable format
region_summary_styled = region_summary.style.format({
    'Revenue EUR': '€{:,.0f}',
    'Gross Profit EUR': '€{:,.0f}'
})

# Display the table
display(region_summary_styled)

# Prepare metrics for AI analysis
region_metrics = {
    'Total Revenue by Region': region_summary['Revenue EUR'].to_dict(),
    'Top Region': f"{region_summary['Revenue EUR'].idxmax()} (€{region_summary['Revenue EUR'].max():,.0f})",
    'Total Profit by Region': region_summary['Gross Profit EUR'].to_dict()
}

# Format metrics for the prompt
region_metrics_text = "\n".join(f"{k}: {v}" for k, v in region_metrics.items())

# Generate AI description
region_analysis = generate_sales_narrative(
    "Regional sales performance across German territories",
    region_metrics_text
)

print(f'''```{{=typst}}
#analysis-box[
  {region_analysis}
]
```''')

```

