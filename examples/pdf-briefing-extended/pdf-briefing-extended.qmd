---
title: "German Sales Analysis"
subtitle: "With AI generated explanations"
author: Mike Farmer
date: today
date-format: long
format:
  typst:
    columns: 1
    papersize: a4
    toc: true
    toc-depth: 2
    toc-page-break: true
jupyter:
  kernelspec:
    name: quarto-mssql-gemini
    display_name: quarto-mssql-gemini
    language: python
---

```{python}
#| echo: false
import pandas as pd
from quarto_mssql_gemini.ai.narrative import generate_sales_narrative
from quarto_mssql_gemini.data_access import get_germany_sales_data
```

```{python}
#| echo: false
# Get the data
germany_sales = get_germany_sales_data().sort_values('Calendar DueDate').copy()
```


```{=typst}
#let analysis-box(content) = {
  block(
    fill: rgb("#f1f5f9"),
    inset: 1em,
    radius: 4pt,
    width: 100%,
  )[
    #text(weight: "bold")[AI Analysis]
    #v(0.5em)
    #content
  ]
}
```


```{=typst}
#pagebreak()
```

# Sales Performance Overview 

```{python}
#| echo: false
#| fig-width: 8
#| fig-height: 4
#| output: asis
# Create a summary of key metrics
summary = germany_sales.groupby('Calendar Month')[['Sales Amount', 'Revenue EUR', 'Gross Profit EUR']].sum()

# Plot monthly revenue with improved PDF styling
summary['Revenue EUR'].plot(kind='line', 
                          figsize=(8, 4), 
                          marker='o',
                          rot=45,
                          grid=True)

# Prepare metrics for AI analysis
monthly_metrics = {
    'Total Revenue': f"€{summary['Revenue EUR'].sum():,.0f}",
    'Average Monthly Revenue': f"€{summary['Revenue EUR'].mean():,.0f}",
    'Peak Month': f"{summary['Revenue EUR'].idxmax()} (€{summary['Revenue EUR'].max():,.0f})",
    'Lowest Month': f"{summary['Revenue EUR'].idxmin()} (€{summary['Revenue EUR'].min():,.0f})"
}

# Format metrics for the prompt
monthly_metrics_text = "\n".join(f"{k}: {v}" for k, v in monthly_metrics.items())

# Generate AI description
monthly_analysis = generate_sales_narrative(
    "Monthly revenue trends in Germany",
    monthly_metrics_text
)

print(f'''```{{=typst}}
#analysis-box[
  {monthly_analysis}
]
```''')

```



```{=typst}
#pagebreak()
```

# Regional Analysis

```{python}
#| echo: false
#| output: asis
# Analyze sales by region in Germany
region_summary = germany_sales.groupby('Sales Region').agg({
    'Sales Amount': 'sum',
    'Revenue EUR': 'sum',
    'Gross Profit EUR': 'sum'
}).round(2)

# Convert to more presentable format
region_summary_styled = region_summary.style.format({
    'Sales Amount': '{:,.0f}',
    'Revenue EUR': '€{:,.0f}',
    'Gross Profit EUR': '€{:,.0f}'
})

display(region_summary_styled)

# Prepare metrics for AI analysis
region_metrics = {
    'Total Revenue by Region': region_summary['Revenue EUR'].to_dict(),
    'Top Region': f"{region_summary['Revenue EUR'].idxmax()} (€{region_summary['Revenue EUR'].max():,.0f})",
    'Total Profit by Region': region_summary['Gross Profit EUR'].to_dict()
}

# Format metrics for the prompt
region_metrics_text = "\n".join(f"{k}: {v}" for k, v in region_metrics.items())

# Generate AI description
region_analysis = generate_sales_narrative(
    "Regional sales performance across German territories",
    region_metrics_text
)

print(f'''```{{=typst}}
#analysis-box[
  {region_analysis}
]
```''')
```

```{=typst}
#pagebreak()
```

# Product Category Performance 

```{python}
#| echo: false
#| fig-width: 8
#| fig-height: 4
#| fig-dpi: 300
#| output: asis
# Calculate product category summary
product_summary = germany_sales.groupby('Product Category').agg({
    'Sales Amount': 'sum',
    'Revenue EUR': 'sum',
    'Gross Profit EUR': 'sum'
}).sort_values('Revenue EUR', ascending=False)

# Create plot with improved PDF styling
ax = product_summary['Revenue EUR'].plot(kind='bar',
                                       figsize=(8, 4),
                                       rot=45)

ax.set_xlabel('Product Category')
ax.set_ylabel('Revenue (EUR)')
ax.grid(True, alpha=0.3)

# Prepare metrics for AI analysis
product_metrics = {
    'Top Category': f"{product_summary.index[0]} (€{product_summary['Revenue EUR'].max():,.0f})",
    'Bottom Category': f"{product_summary.index[-1]} (€{product_summary['Revenue EUR'].min():,.0f})",
    'Category Revenue Share': dict(zip(product_summary.index, 
                                     (product_summary['Revenue EUR'] / product_summary['Revenue EUR'].sum() * 100).round(1)))
}

# Format metrics for the prompt
product_metrics_text = "\n".join(f"{k}: {v}" for k, v in product_metrics.items())

# Generate AI description
product_analysis = generate_sales_narrative(
    "Product category revenue distribution",
    product_metrics_text
)

print(f'''```{{=typst}}
#analysis-box[
  {product_analysis}
]
```''')
```
